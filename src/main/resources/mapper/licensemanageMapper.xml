<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hamonsoft.cportal.repository.LicenseManageRepository">
    <!--  사용자 전체 건수  -->
   <select id="licensePolicyList" resultType="hashmap">
       select a01.licensepolicyid ,      --   라이센스정책관리번호(uuid)
               a01.solutioncode    ,      --   솔루션코드
               a01.policycode      ,      --   라이센스정책코드(등급)
               a01.solutionname    ,      --   라이센스정책솔루션명
               a01.policyname      ,      --   라이센스정책명
               a01.licensecontent  ,      --   라이센스정책내용
               a01.licenseamount   ,      --   라이센스기본요금
               a01.licenseint      ,      --   라이센스가용장비수
               a01.aidcode         ,      --   지원기능구분(003)
               a01.stdate          ,      --   시작일자
               a01.eddate          ,      --   종료일자
               str_to_date(a01.stdate,'%Y%m%d') strstdate,
               str_to_date(a01.eddate,'%Y%m%d') streddate,
               a01.useyn           ,      --   사용여부
               a01.sortno          ,      --   정렬기준
               a01.createdAt       ,      --   등록일시
               a01.updatedAt       ,       --   수정일시
               row_number() over (order by a01.solutioncode ,a01.createdAt desc) numrow
       from tblicensepolicy a01
       where 1 = 1
       <choose>
           <when test="solutioncode != null and solutioncode neq ''">
               AND a01.solutioncode = #{solutioncode}
           </when>
       </choose>
   </select>

    <select id="aidfunctionList" resultType="hashmap">
        select
            a01.solutioncode ,
            j02.codename solutionname,
            a01.functioncode ,
            j01.codename  fnccodename,
            a01.functionno ,
            a01.functionname ,
            case when a01.freeaid = 'O' then '지원' when a01.freeaid = 'X' then '지원안함' else a01.freeaid end freenm, a01.freeaid,
            case when a01.basicaid = 'O' then '지원' when a01.basicaid = 'X' then '지원안함' else a01.basicaid end basicnm, a01.basicaid,
            case when a01.proaid = 'O' then '지원' when a01.proaid = 'X' then '지원안함' else a01.proaid end pronm, a01.proaid,
            case when a01.entaid = 'O' then '지원' when a01.entaid = 'X' then '지원안함' else a01.entaid end entnm, a01.entaid,
            a01.useyn ,
            STR_TO_DATE(a01.stdate, '%Y%m%d') stdate,
            STR_TO_DATE(a01.eddate, '%Y%m%d') eddate,
            a01.sortno ,
            row_number() over (order by a01.functioncode ,a01.createdAt desc) numrow
        from tbaidfunction a01
        inner join tbcommoncode j01 on j01.groupcode = '003' and a01.functioncode = j01.commoncode
        inner join tbcommoncode j02 on j02.groupcode = '002' and a01.solutioncode = j02.commoncode
        where 1 = 1
        <choose>
            <when test="solutioncode != null and solutioncode neq ''">
                AND a01.solutioncode = if(#{solutioncode}='00',a01.solutioncode,#{solutioncode})
            </when>
        </choose>
        order by j01.sortno, a01.functionno
    </select>



    <select id="aidfunctionList1" resultType="hashmap">
        select a01.solutioncode   ,
        a01.functioncode    ,
        j01.codename        fnccodename,
        a01.useyn      ,
        a01.sortno
        from tbaidfunction a01
        inner join tbcommoncode j01
        on j01.groupcode    = '003'
        and a01.functioncode = j01.commoncode
        where 1 = 1
        <choose>
            <when test="solutioncode != null and solutioncode neq ''">
                AND a01.solutioncode = if(#{solutioncode}='00',a01.solutioncode,#{solutioncode})
            </when>
        </choose>
        order by j01.sortno, a01.functionno
    </select>



    <select id="aidfunctionList2" resultType="hashmap">
        select
            a01.solutioncode ,
            j02.codename solutionname,
            a01.functioncode ,
            j01.codename  fnccodename,
            a01.functionno ,
            a01.functionname ,
            case when a01.freeaid = 'O' then '지원' when a01.freeaid = 'X' then '지원안함' else a01.freeaid end freenm, a01.freeaid,
            case when a01.basicaid = 'O' then '지원' when a01.basicaid = 'X' then '지원안함' else a01.basicaid end basicnm, a01.basicaid,
            case when a01.proaid = 'O' then '지원' when a01.proaid = 'X' then '지원안함' else a01.proaid end pronm, a01.proaid,
            case when a01.entaid = 'O' then '지원' when a01.entaid = 'X' then '지원안함' else a01.entaid end entnm, a01.entaid,
            a01.useyn ,
            STR_TO_DATE(a01.stdate, '%Y%m%d') stdate,
            STR_TO_DATE(a01.eddate, '%Y%m%d') eddate,
            a01.sortno ,
            row_number() over (order by a01.functioncode ,a01.createdAt desc) numrow
        from tbaidfunction a01
        inner join tbcommoncode j01 on j01.groupcode = '003' and a01.functioncode = j01.commoncode
        inner join tbcommoncode j02 on j02.groupcode = '002' and a01.solutioncode = j02.commoncode
        where 1 = 1
        <choose>
            <when test="solutioncode != null and solutioncode neq ''">
                AND a01.solutioncode = if(#{solutioncode}='00',a01.solutioncode,#{solutioncode})
            </when>
        </choose>
        order by j01.sortno, a01.functionno
    </select>

    <select id="creditList" resultType="hashmap">
        select a01.groupcode  ,      --   group code
               a01.commoncode    ,      --   공통코드
               a01.codename      ,      --   코드명
               a01.applyvolume    ,      --   적용수량(Credit 적용,라이센스정책)
               a01.useyn      ,      --   사용여부
               a01.stdate          ,      --   시작일자
               a01.eddate          ,      --   종료일자
               str_to_date(a01.stdate,'%Y%m%d') strstdate,
               str_to_date(a01.eddate,'%Y%m%d') streddate,       --   수정일시
               row_number() over (order by a01.commoncode ,a01.stdate desc) numrow
        from tbcommoncode a01
        where 1 = 1
          and a01.groupcode = '006'

        order by a01.sortno
    </select>

    <!--  가격정책별 지원기능  -->
    <insert id="aidfunctionInsert">
        INSERT INTO tbaidfunction(
                                  functionname   , freeaid       ,basicaid   ,proaid
                                 ,entaid         , functioncode  ,useyn      ,sortno      )
        values(#{functionname}, #{freeaid}    ,#{basicaid},#{proaid}
             ,#{entaid}      , #{functioncode} ,#{useyn} ,#{sortno})
    </insert>

    <!--  가격정책별 지원기능  -->
    <update id="aidfunctionUpdate">
        UPDATE tbaidfunction
           SET functionname =#{functionname}
             ,freeaid =#{freeaid}
             ,basicaid =#{basicaid}
             ,proaid =#{proaid}
             ,entaid =#{entaid}
             ,functioncode =#{functioncode}
             ,useyn=#{useyn}
             ,sortno=#{sortno}
        WHERE functionno = ${functionno}
    </update>
</mapper>